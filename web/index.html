<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASE Circle</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/regular/style.css">
</head>
<body>
    <div class="app">
        <!-- Header with Navigation -->
        <header class="header">
            <div class="header-left">
                <h1>MASE</h1>
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-view="circle"><i class="ph ph-circle-notch"></i> Circle</button>
                    <button class="nav-tab" data-view="sessions"><i class="ph ph-archive"></i> Sessions</button>
                </nav>
            </div>
            <div class="header-right">
                <span class="status-indicator" id="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Disconnected</span>
                </span>
            </div>
        </header>

        <!-- ================================================================
             CIRCLE VIEW (Main dialogue interface)
             ================================================================ -->
        <main class="main view-container" id="circle-view">
            <!-- Sidebar with agents -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h2><i class="ph ph-users-three"></i> The Circle</h2>
                    <div class="agents-list" id="agents-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Live Metrics Panel -->
                <div class="sidebar-section" id="metrics-panel">
                    <h2><i class="ph ph-pulse"></i> Live Metrics</h2>
                    <div class="metrics-content">
                        <div class="metric-row">
                            <span class="metric-label">Basin</span>
                            <span id="live-basin" class="basin-badge">—</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Integrity</span>
                            <span id="live-integrity" class="integrity-indicator">—</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Voice Dist.</span>
                            <span id="live-voice-dist" class="metric-value-small">—</span>
                        </div>
                        <div class="psi-bars">
                            <div class="psi-bar">
                                <span class="psi-label">Semantic</span>
                                <div class="psi-track">
                                    <div class="psi-fill" id="psi-semantic-fill"></div>
                                    <div class="psi-center"></div>
                                </div>
                            </div>
                            <div class="psi-bar">
                                <span class="psi-label">Temporal</span>
                                <div class="psi-track">
                                    <div class="psi-fill" id="psi-temporal-fill"></div>
                                    <div class="psi-center"></div>
                                </div>
                            </div>
                            <div class="psi-bar">
                                <span class="psi-label">Affective</span>
                                <div class="psi-track">
                                    <div class="psi-fill" id="psi-affective-fill"></div>
                                    <div class="psi-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Perturbation Panel -->
                <div class="sidebar-section collapsible" id="perturbation-panel">
                    <h2 class="collapsible-header">
                        <i class="ph ph-lightning"></i> Perturb
                        <i class="ph ph-caret-down collapse-toggle"></i>
                    </h2>
                    <div class="panel-content">
                        <div class="perturb-buttons">
                            <button class="perturb-btn" data-template="challenge"><i class="ph ph-sword"></i> Challenge</button>
                            <button class="perturb-btn" data-template="luma"><i class="ph ph-star"></i> Ask Luma</button>
                            <button class="perturb-btn" data-template="shake"><i class="ph ph-shuffle"></i> Shake Up</button>
                            <button class="perturb-btn" data-template="consolidate"><i class="ph ph-arrows-in"></i> Consolidate</button>
                        </div>
                        <div class="perturb-custom">
                            <textarea id="custom-prompt" placeholder="Custom prompt..."></textarea>
                            <button class="btn btn-secondary" id="inject-custom-btn"><i class="ph ph-syringe"></i> Inject</button>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h2><i class="ph ph-sliders-horizontal"></i> Controls</h2>
                    <div class="controls">
                        <button class="btn btn-control" id="pause-btn" disabled>
                            <i class="ph ph-pause"></i> Pause
                        </button>
                        <button class="btn btn-control" id="resume-btn" disabled>
                            <i class="ph ph-play"></i> Resume
                        </button>
                        <button class="btn btn-control btn-end" id="end-btn" disabled>
                            <i class="ph ph-stop"></i> End & Analyze
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h2><i class="ph ph-info"></i> Session</h2>
                    <div class="session-info" id="session-info">
                        <div class="info-row">
                            <span class="info-label">ID:</span>
                            <span class="info-value" id="session-id">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Turns:</span>
                            <span class="info-value" id="turn-count">0</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Dialogue area -->
            <section class="dialogue-container">
                <!-- Start screen -->
                <div class="start-screen" id="start-screen">
                    <div class="start-content">
                        <h2>Start a New Dialogue</h2>
                        <p>Enter a provocation and select which personas join the circle.</p>

                        <div class="provocation-input">
                            <textarea
                                id="provocation-input"
                                placeholder="What does it mean to live well?"
                                rows="3"
                            ></textarea>
                        </div>

                        <!-- Persona Selection -->
                        <div class="persona-selection-section">
                            <div class="persona-selection-header">
                                <h3><i class="ph ph-users-three"></i> Select Personas <span id="persona-count" class="persona-count">0 selected</span></h3>
                                <label class="include-human-label">
                                    <input type="checkbox" id="include-human" checked>
                                    <span>Include yourself</span>
                                </label>
                            </div>
                            <div class="persona-selection" id="persona-selection">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <button class="btn btn-primary btn-start-circle" id="start-btn">
                            <i class="ph ph-play-circle"></i> Begin Circle
                        </button>

                        <div class="example-provocations">
                            <p>Or try one of these:</p>
                            <div class="example-list">
                                <button class="example-btn">What does success mean?</button>
                                <button class="example-btn">Why don't adults treat suffering as an emergency?</button>
                                <button class="example-btn">How do we coordinate without coercion?</button>
                                <button class="example-btn">What would genuine progress look like?</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dialogue view -->
                <div class="dialogue-view hidden" id="dialogue-view">
                    <!-- Provocation banner -->
                    <div class="provocation-banner" id="provocation-banner">
                        <div class="provocation-label">Exploring:</div>
                        <div class="provocation-text" id="provocation-text"></div>
                    </div>

                    <!-- Messages -->
                    <div class="dialogue-messages" id="dialogue-messages">
                        <!-- Messages populated by JavaScript -->
                    </div>

                    <!-- Speaking indicator -->
                    <div class="speaking-indicator hidden" id="speaking-indicator">
                        <span class="speaking-dot"></span>
                        <span class="speaking-text"></span>
                    </div>

                    <!-- Human input area -->
                    <div class="input-area" id="input-area">
                        <div class="input-wrapper">
                            <textarea
                                id="human-input"
                                placeholder="Add your voice to the circle..."
                                rows="2"
                            ></textarea>
                            <button class="btn btn-primary" id="send-btn" disabled>
                                <i class="ph ph-paper-plane-tilt"></i> Send
                            </button>
                        </div>
                        <div class="quick-prompts" id="quick-prompts">
                            <button class="quick-btn" data-action="continue"><i class="ph ph-arrow-right"></i> Continue</button>
                            <button class="quick-btn" data-action="common-ground"><i class="ph ph-intersect"></i> Find common ground</button>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results View (after ending session) -->
                <div class="analysis-view hidden" id="analysis-view">
                    <div class="analysis-header">
                        <h2><i class="ph ph-magnifying-glass"></i> Session Review</h2>
                        <div class="analysis-header-tabs">
                            <button class="analysis-tab active" data-tab="dialogue"><i class="ph ph-chat-circle-text"></i> Dialogue</button>
                            <button class="analysis-tab" data-tab="analysis"><i class="ph ph-chart-line"></i> Analysis</button>
                        </div>
                        <button class="btn btn-secondary" id="close-analysis-btn"><i class="ph ph-plus-circle"></i> Start New Session</button>
                    </div>

                    <!-- Dialogue Tab -->
                    <div class="analysis-tab-content" id="analysis-dialogue-tab">
                        <div class="analysis-dialogue-messages" id="analysis-dialogue-messages">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Analysis Tab -->
                    <div class="analysis-tab-content hidden" id="analysis-metrics-tab">
                        <div class="analysis-content">
                            <div class="analysis-summary" id="analysis-summary">
                                <!-- Populated by JavaScript -->
                            </div>
                            <div class="analysis-details">
                                <div class="analysis-section">
                                    <h3>Basin Trajectory</h3>
                                    <div class="basin-chart" id="basin-chart"></div>
                                </div>
                                <div class="analysis-section">
                                    <h3>Metrics</h3>
                                    <div class="metrics-grid" id="metrics-grid"></div>
                                </div>
                                <div class="analysis-section">
                                    <h3>Agent Participation</h3>
                                    <div class="agent-stats" id="agent-stats"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- ================================================================
             SESSIONS VIEW (Browse and review past sessions)
             ================================================================ -->
        <main class="main view-container hidden" id="sessions-view">
            <div class="sessions-container">
                <!-- Sessions List -->
                <div class="sessions-list-panel" id="sessions-list-panel">
                    <div class="sessions-list-header">
                        <h2><i class="ph ph-folder-open"></i> Past Sessions</h2>
                        <span class="sessions-count" id="sessions-count">0 sessions</span>
                    </div>
                    <div class="sessions-list" id="sessions-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Session Detail -->
                <div class="session-detail-panel" id="session-detail-panel">
                    <div class="session-detail-empty" id="session-detail-empty">
                        <p>Select a session to view its dialogue and analysis</p>
                    </div>
                    <div class="session-detail-content hidden" id="session-detail-content">
                        <div class="session-detail-header">
                            <div class="session-detail-meta">
                                <span class="detail-session-id" id="detail-session-id"></span>
                                <span class="detail-timestamp" id="detail-timestamp"></span>
                            </div>
                            <div class="session-detail-tabs">
                                <button class="detail-tab active" data-tab="dialogue"><i class="ph ph-chat-circle-text"></i> Dialogue</button>
                                <button class="detail-tab" data-tab="analysis"><i class="ph ph-chart-line"></i> Analysis</button>
                            </div>
                        </div>
                        <div class="session-detail-provocation" id="detail-provocation"></div>

                        <!-- Dialogue Tab -->
                        <div class="detail-tab-content" id="detail-dialogue-tab">
                            <div class="detail-dialogue-messages" id="detail-dialogue-messages">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Analysis Tab -->
                        <div class="detail-tab-content hidden" id="detail-analysis-tab">
                            <div class="detail-analysis-content" id="detail-analysis-content">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- End Session Modal -->
    <div class="modal-overlay hidden" id="end-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>End Session</h3>
            </div>
            <div class="modal-body">
                <p>This will end the current dialogue and run semantic analysis on the conversation.</p>
                <p class="modal-detail">Analysis includes basin detection, coherence patterns, and voice distinctiveness metrics.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-end-btn"><i class="ph ph-x"></i> Cancel</button>
                <button class="btn btn-primary" id="confirm-end-btn"><i class="ph ph-check"></i> End & Analyze</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Analyzing session...</div>
            <div class="loading-detail" id="loading-detail">Computing embeddings and detecting basins</div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="sessions.js"></script>
    <script src="app.js"></script>
</body>
</html>
